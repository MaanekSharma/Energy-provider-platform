<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sales - EnergyPro</title>
  <link rel="stylesheet" href="style.css">
  <!-- Chart.js via CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <!-- Navbar Placeholder -->
  <div id="navbar-placeholder"></div>
  
  <!-- Page Header -->
  <header class="page-header">
    <h1>Sales Management</h1>
    <p>View revenue per product for a selected date range.</p>
  </header>
  
  <!-- Filter Section -->
  <section class="sales-filter-section">
    <h2>Filter Sales Data</h2>
    <div class="filter-container">
      <div class="filter-group">
        <label for="startDate">Start Date:</label>
        <input type="date" id="startDate">
      </div>
      <div class="filter-group">
        <label for="endDate">End Date:</label>
        <input type="date" id="endDate">
      </div>
      <button id="filterBtn" class="cta-button">Apply Filter</button>
    </div>
  </section>
  
  <!-- Sales Chart Section -->
  <section class="sales-chart-section">
    <h2>Sales by Product</h2>
    <canvas id="salesChart"></canvas>
  </section>
  
  <!-- Footer -->
  <footer>
    <p>&copy; 2025 EnergyPro. All rights reserved.</p>
  </footer>
  
  <!-- Load the common navbar and its JavaScript -->
  <script>
    fetch('/static/navbar.html')
      .then(response => response.text())
      .then(html => {
        document.getElementById('navbar-placeholder').innerHTML = html;
        const script = document.createElement('script');
        script.src = '/static/navbar.js';
        document.body.appendChild(script);
      })
      .catch(err => console.error("Failed to load navbar:", err));
  </script>
  
  <!-- JavaScript to fetch and render sales data -->
  <script>
    function loadSalesByProduct() {
      const start = document.getElementById("startDate").value;
      const end = document.getElementById("endDate").value;
      
      // Construct the API URL with query parameters if dates are provided.
      let url = 'http://127.0.0.1:18080/api/salesByProduct';
      if (start && end) {
        url += `?start_date=${encodeURIComponent(start)}&end_date=${encodeURIComponent(end)}`;
      }
      
      fetch(url, { credentials: 'include' })
        .then(response => response.json())
        .then(data => {
          const labels = [];
          const revenues = [];
          data.data.forEach(item => {
            labels.push(item.product);
            revenues.push(item.revenue); // using revenue field from the query
          });
          renderSalesChart(labels, revenues);
        })
        .catch(err => console.error("Failed to fetch sales data:", err));
    }
    
    function renderSalesChart(labels, salesData) {
      // Destroy previous chart instance if it exists
      if (window.salesChart && typeof window.salesChart.destroy === 'function') {
        window.salesChart.destroy();
      }
      const ctx = document.getElementById('salesChart').getContext('2d');
      
      const colors = [
        'rgba(255, 99, 132, 0.5)',
        'rgba(54, 162, 235, 0.5)',
        'rgba(255, 206, 86, 0.5)',
        'rgba(75, 192, 192, 0.5)',
        'rgba(153, 102, 255, 0.5)',
        'rgba(255, 159, 64, 0.5)',
        'rgba(199, 199, 199, 0.5)',
        'rgba(83, 102, 255, 0.5)',
        'rgba(255, 99, 71, 0.5)',
        'rgba(60, 179, 113, 0.5)'
      ];
      const borderColors = [
        'rgba(255, 99, 132, 1)',
        'rgba(54, 162, 235, 1)',
        'rgba(255, 206, 86, 1)',
        'rgba(75, 192, 192, 1)',
        'rgba(153, 102, 255, 1)',
        'rgba(255, 159, 64, 1)',
        'rgba(199, 199, 199, 1)',
        'rgba(83, 102, 255, 1)',
        'rgba(255, 99, 71, 1)',
        'rgba(60, 179, 113, 1)'
      ];
      
      // Generate color arrays matching the number of labels
      const backgroundColors = labels.map((label, index) => colors[index % colors.length]);
      const borderColorsArray = labels.map((label, index) => borderColors[index % borderColors.length]);
      
      window.salesChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'Revenue ($)',
            data: salesData,
            backgroundColor: backgroundColors,
            borderColor: borderColorsArray,
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: { beginAtZero: true }
          },
          plugins: {
            legend: {
              display: false 
            }
          }
        }
      });
    }
    
    document.getElementById("filterBtn").addEventListener("click", loadSalesByProduct);
    window.addEventListener('load', loadSalesByProduct);
  </script>
</body>
</html>
